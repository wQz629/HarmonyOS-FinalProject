/*
 * Copyright (c) 2023 Huawei Device Co., Ltd.
 * Licensed under the Apache License,Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import * as commonConst from '../common/CommonConstants';
import { GoodsListItemType } from '../viewmodel/InitialData';
import { ListDataSource } from '../viewmodel/ListDataSource';
import { ThemeColors, DEFAULT_THEME } from '../common/Colors';
import router from '@ohos.router'; // å¼•å…¥è·¯ç”±æ¨¡å—
import promptAction from '@ohos.promptAction';

@Component
export default struct GoodsList {
  // ðŸ‘‡ 1. é“¾æŽ¥å…¨å±€å¯¹æ¯”åˆ—è¡¨ï¼Œåˆå§‹åŒ–ä¸ºç©ºæ•°ç»„
  @StorageLink('compareList') compareList: GoodsListItemType[] = [];
  @StorageLink('themeColors') currentThemeColors: ThemeColors = DEFAULT_THEME;

  @Provide goodsListData: ListDataSource = new ListDataSource();
  private startTouchOffsetY: number = 0;
  private endTouchOffsetY: number = 0;

  // åˆ¤æ–­å•†å“æ˜¯å¦å·²åœ¨å¯¹æ¯”åˆ—è¡¨ä¸­
  isInCompareList(item: GoodsListItemType): boolean {
    return this.compareList.some(compareItem => compareItem.id === item.id);
  }

  // å¤„ç†å¯¹æ¯”ç‚¹å‡»
  handleCompare(item: GoodsListItemType) {
    if (this.isInCompareList(item)) {
      // å¦‚æžœå·²å­˜åœ¨ï¼Œåˆ™ç§»é™¤
      this.compareList = this.compareList.filter(compareItem => compareItem.id !== item.id);
    } else {
      // å¦‚æžœä¸å­˜åœ¨ï¼Œåˆ¤æ–­æ˜¯å¦è¶…è¿‡é™åˆ¶ (æ¯”å¦‚æœ€å¤š2ä¸ª)
      if (this.compareList.length >= 2) {
        promptAction.showToast({ message: 'æœ€å¤šåŒæ—¶å¯¹æ¯”ä¸¤ä¸ªå•†å“' });
        return;
      }
      // åŠ å…¥å¯¹æ¯”
      this.compareList.push(item);
      promptAction.showToast({ message: 'å·²åŠ å…¥å¯¹æ¯”' });
    }
  }


  build() {
    Stack({ alignContent: Alignment.BottomEnd }) { // ä½¿ç”¨ Stack ä»¥ä¾¿æ”¾ç½®æ‚¬æµ®æŒ‰é’®
      Row() {
        List({ space: commonConst.LIST_ITEM_SPACE }) {
          LazyForEach(this.goodsListData, (item: GoodsListItemType) => {
            ListItem() {
              Row() {
                // ... åŽŸæœ‰çš„å›¾ç‰‡ Column ...
                Column() {
                  Image(item?.goodsImg)
                    .width(commonConst.LAYOUT_WIDTH_OR_HEIGHT)
                    .height(commonConst.LAYOUT_WIDTH_OR_HEIGHT)
                    .draggable(false)
                }
                .width(commonConst.GOODS_IMAGE_WIDTH)
                .height(commonConst.LAYOUT_WIDTH_OR_HEIGHT)

                Column() {
                  Text(item?.goodsName)
                    .fontSize(commonConst.NORMAL_FONT_SIZE)
                    .fontColor(this.currentThemeColors.primaryTextColor)

                  Text(item?.advertisingLanguage)
                    .fontColor(this.currentThemeColors.primaryTextColor)
                    .fontSize(commonConst.GOODS_EVALUATE_FONT_SIZE)
                    .margin({ right: commonConst.MARGIN_RIGHT })

                  Row() {
                    // ä»·æ ¼å’Œè¯„ä»·
                    Column() {
                      Text(item?.evaluate)
                        .fontSize(commonConst.GOODS_EVALUATE_FONT_SIZE)
                        .fontColor(this.currentThemeColors.accentColor)
                      Text(item?.price)
                        .fontSize(commonConst.NORMAL_FONT_SIZE)
                        .fontColor(this.currentThemeColors.accentColor)
                    }
                    .alignItems(HorizontalAlign.Start)

                    // ðŸ‘‡ 2. æ–°å¢žï¼šå¯¹æ¯”å›¾æ ‡/æŒ‰é’®
                    Image(this.isInCompareList(item) ? $r('app.media.ic_compare_selected') : $r('app.media.ic_compare_unselected')) // ç¡®ä¿ä½ æœ‰è¿™ä¸ªå›¾æ ‡ï¼Œæˆ–è€…ç”¨å…¶ä»–å›¾æ ‡ä»£æ›¿
                      .width(24)
                      .height(24)
                      .gesture(
                        TapGesture()
                          .onAction(() => {
                            // TapGesture é»˜è®¤ä¼šæ¶ˆè´¹äº‹ä»¶ï¼Œé€šå¸¸ä¸ä¼šå†’æ³¡ç»™çˆ¶ç»„ä»¶çš„ onClick
                            this.handleCompare(item);
                          })
                      )
                  }
                  .justifyContent(FlexAlign.SpaceBetween) // æ”¹ä¸ºä¸¤ç«¯å¯¹é½
                  .width('100%') // å æ»¡å®½åº¦
                }
                .padding(commonConst.GOODS_LIST_PADDING)
                .width(commonConst.GOODS_FONT_WIDTH)
                .height(commonConst.LAYOUT_WIDTH_OR_HEIGHT)
                .justifyContent(FlexAlign.SpaceBetween)
              }
              .justifyContent(FlexAlign.SpaceBetween)
              .height(commonConst.GOODS_LIST_HEIGHT)
              .width(commonConst.LAYOUT_WIDTH_OR_HEIGHT)
            }
            .onClick(() => {
              router.pushUrl({
                url: 'pages/GoodsDetailPage',
                params: {
                  goodsId: item.id,
                  goodsName: item.goodsName,
                  goodsPrice: item.price,
                  goodsImg: item.goodsImg
                }
              })
            })
          })
        }
        .width(commonConst.GOODS_LIST_WIDTH)
        .divider({ strokeWidth: 1, color: this.currentThemeColors.dividerColor })
      }
      .justifyContent(FlexAlign.Center)
      .width(commonConst.LAYOUT_WIDTH_OR_HEIGHT)

      // ðŸ‘‡ 3. æ–°å¢žï¼šè¿›å…¥å¯¹æ¯”é¡µé¢çš„æ‚¬æµ®å…¥å£
      if (this.compareList.length > 0) {
        Button(`å¼€å§‹å¯¹æ¯” (${this.compareList.length})`)
          .backgroundColor(this.currentThemeColors.accentColor)
          .fontColor(Color.White)
          .margin({ bottom: 80, right: 20 }) // è°ƒæ•´ä½ç½®
          .onClick(() => {
            if (this.compareList.length < 2) {
              promptAction.showToast({ message: 'è¯·è‡³å°‘é€‰æ‹©ä¸¤ä¸ªå•†å“è¿›è¡Œå¯¹æ¯”' });
              return;
            }
            router.pushUrl({ url: 'pages/ComparisonPage' });
          })
      }
    }
    .width('100%')
    .height('100%')
  }
}